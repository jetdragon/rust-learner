# 综合练习：简单数据库系统

## 项目简介

本综合练习需要你运用结构体和枚举的知识，实现一个支持多种数据类型的简单内存数据库系统。

## 项目需求

### 功能描述

创建一个内存数据库，支持：
1. 存储不同类型的数据（整数、字符串、布尔值）
2. 查询数据
3. 更新数据
4. 删除数据
5. 支持事务

### 核心数据结构

#### 1. 数据类型枚举

```rust
enum Value {
    Integer(i64),
    Float(f64),
    Text(String),
    Boolean(bool),
    Null,
}
```

#### 2. 数据库行

```rust
struct Row {
    id: u32,
    data: HashMap<String, Value>,
}
```

#### 3. 数据库表

```rust
struct Table {
    name: String,
    rows: Vec<Row>,
    next_id: u32,
}
```

#### 4. 查询条件枚举

```rust
enum Condition {
    Equals { column: String, value: Value },
    GreaterThan { column: String, value: Value },
    LessThan { column: String, value: Value },
    And(Box<Condition>, Box<Condition>),
    Or(Box<Condition>, Box<Condition>),
}
```

#### 5. 查询结果

```rust
enum QueryResult {
    Success(Vec<Row>),
    Error(String),
}
```

#### 6. 数据库

```rust
struct Database {
    tables: HashMap<String, Table>,
}
```

### 必须实现的功能

#### Table 方法

1. `new(name: String) -> Self`
   - 创建新表

2. `insert(&mut self, data: HashMap<String, Value>) -> Result<u32, String>`
   - 插入一行数据
   - 返回新行的 ID

3. `select(&self, condition: Option<&Condition>) -> Vec<Row>`
   - 查询数据
   - 如果条件为 None，返回所有行

4. `update(&mut self, id: u32, data: HashMap<String, Value>) -> Result<(), String>`
   - 更新指定 ID 的行
   - 返回成功或错误信息

5. `delete(&mut self, id: u32) -> Result<(), String>`
   - 删除指定 ID 的行

6. `count(&self) -> usize`
   - 返回行数

#### Database 方法

7. `new() -> Self`
   - 创建新数据库

8. `create_table(&mut self, name: String) -> Result<(), String>`
   - 创建新表
   - 如果表已存在，返回错误

9. `get_table(&self, name: &str) -> Option<&Table>`
   - 获取表的引用

10. `get_table_mut(&mut self, name: &str) -> Option<&mut Table>`
    - 获取表的可变引用

#### Value 方法

11. `impl From<i64> for Value`
    - 从 i64 转换

12. `impl From<f64> for Value`
    - 从 f64 转换

13. `impl From<String> for Value`
    - 从 String 转换

14. `impl From<bool> for Value`
    - 从 bool 转换

15. `impl Display for Value`
    - 实现 Display trait 用于打印

### Condition 方法

16. `matches(&self, row: &Row) -> bool`
    - 判断行是否满足条件

### 使用示例

```rust
use module_03_structs_enums::database::*;

fn main() {
    // 创建数据库
    let mut db = Database::new();

    // 创建表
    db.create_table("users".to_string()).unwrap();

    // 插入数据
    let mut user1 = HashMap::new();
    user1.insert("name".to_string(), Value::Text("Alice".to_string()));
    user1.insert("age".to_string(), Value::Integer(30));
    user1.insert("active".to_string(), Value::Boolean(true));

    let mut user2 = HashMap::new();
    user2.insert("name".to_string(), Value::Text("Bob".to_string()));
    user2.insert("age".to_string(), Value::Integer(25));
    user2.insert("active".to_string(), Value::Boolean(false));

    if let Some(table) = db.get_table_mut("users") {
        let id1 = table.insert(user1).unwrap();
        let id2 = table.insert(user2).unwrap();
        println!("插入了用户 ID: {} 和 {}", id1, id2);
    }

    // 查询所有用户
    if let Some(table) = db.get_table("users") {
        println!("\n所有用户:");
        for row in table.select(None) {
            println!("  ID: {}", row.id);
            for (key, value) in &row.data {
                println!("    {}: {}", key, value);
            }
        }
    }

    // 条件查询
    let condition = Condition::Equals {
        column: "active".to_string(),
        value: Value::Boolean(true),
    };

    if let Some(table) = db.get_table("users") {
        println!("\n活跃用户:");
        for row in table.select(Some(&condition)) {
            println!("  {}", row.data.get("name").unwrap());
        }
    }

    // 更新数据
    if let Some(table) = db.get_table_mut("users") {
        let mut update_data = HashMap::new();
        update_data.insert("age".to_string(), Value::Integer(31));
        let _ = table.update(1, update_data);

        println!("\n更新后的用户 1:");
        if let Some(row) = table.select(Some(&Condition::Equals {
            column: "id".to_string(),
            value: Value::Integer(1),
        })).first() {
            for (key, value) in &row.data {
                println!("  {}: {}", key, value);
            }
        }
    }
}
```

## 验收标准

### 功能要求

- [ ] 所有枚举和结构体定义正确
- [ ] 所有 16 个方法正确实现
- [ ] Value 支持所有基本类型转换
- [ ] Condition 支持复合条件（And、Or）
- [ ] 错误处理完善

### 代码质量

- [ ] 所有单元测试通过
- [ ] 代码通过 `cargo clippy` 检查
- [ ] 代码格式化 `cargo fmt`
- [ ] 有适当的文档注释

### 测试覆盖

- [ ] 测试插入功能
- [ ] 测试查询功能（无条件）
- [ ] 测试条件查询（所有条件类型）
- [ ] 测试更新功能
- [ ] 测试删除功能
- [ ] 测试错误处理
- [ ] 测试边界情况

## 实现步骤

1. **创建文件结构**：
   ```bash
   mkdir -p src/database
   touch src/database/mod.rs
   touch src/database/value.rs
   touch src/database/condition.rs
   ```

2. **实现 Value 枚举**：
   - 定义枚举变体
   - 实现 From trait
   - 实现 Display trait

3. **实现 Condition 枚举**：
   - 定义枚举变体
   - 实现 matches 方法

4. **实现 Row 和 Table**：
   - 定义结构体
   - 实现所有方法

5. **实现 Database**：
   - 定义结构体
   - 实现所有方法

6. **编写测试**：
   - 单元测试
   - 集成测试

7. **运行验证**：
   ```bash
   cargo test -p module-03-structs-enums
   cargo clippy -p module-03-structs-enums
   cargo fmt -p module-03-structs-enums
   ```

## 测试用例

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_value_from() {
        let v: Value = 42.into();
        assert!(matches!(v, Value::Integer(42)));
    }

    #[test]
    fn test_insert_and_select() {
        let mut table = Table::new("test".to_string());
        let mut data = HashMap::new();
        data.insert("name".to_string(), Value::Text("Test".to_string()));

        let id = table.insert(data).unwrap();
        assert_eq!(id, 1);

        let rows = table.select(None);
        assert_eq!(rows.len(), 1);
        assert_eq!(rows[0].id, 1);
    }

    #[test]
    fn test_condition_equals() {
        let mut table = Table::new("test".to_string());
        let mut data1 = HashMap::new();
        data1.insert("status".to_string(), Value::Text("active".to_string()));
        table.insert(data1);

        let condition = Condition::Equals {
            column: "status".to_string(),
            value: Value::Text("active".to_string()),
        };

        let rows = table.select(Some(&condition));
        assert_eq!(rows.len(), 1);
    }

    #[test]
    fn test_update() {
        let mut table = Table::new("test".to_string());
        let mut data = HashMap::new();
        data.insert("value".to_string(), Value::Integer(10));
        let id = table.insert(data).unwrap();

        let mut update = HashMap::new();
        update.insert("value".to_string(), Value::Integer(20));
        table.update(id, update).unwrap();

        let rows = table.select(None);
        assert!(matches!(rows[0].data.get("value"), Some(Value::Integer(20))));
    }

    #[test]
    fn test_delete() {
        let mut table = Table::new("test".to_string());
        let mut data = HashMap::new();
        data.insert("name".to_string(), Value::Text("Test".to_string()));
        let id = table.insert(data).unwrap();

        table.delete(id).unwrap();
        assert_eq!(table.count(), 0);
    }

    #[test]
    fn test_database_create_table() {
        let mut db = Database::new();
        db.create_table("users".to_string()).unwrap();
        assert!(db.get_table("users").is_some());
    }

    #[test]
    fn test_condition_and() {
        let condition = Condition::And(
            Box::new(Condition::Equals {
                column: "a".to_string(),
                value: Value::Integer(1),
            }),
            Box::new(Condition::Equals {
                column: "b".to_string(),
                value: Value::Integer(2),
            }),
        );

        let mut row = Row {
            id: 1,
            data: HashMap::new(),
        };
        row.data.insert("a".to_string(), Value::Integer(1));
        row.data.insert("b".to_string(), Value::Integer(2));

        assert!(condition.matches(&row));
    }
}
```

## 扩展挑战（可选）

完成基础要求后，可以尝试以下扩展：

1. **索引支持**：
   - 为某些列创建索引
   - 加速查询性能

2. **范围查询**：
   - 添加 `Between` 条件
   - 添加 `In` 条件

3. **排序功能**：
   - `select_order_by` 方法
   - 支持升序和降序

4. **聚合函数**：
   - `count` - 计数
   - `sum` - 求和
   - `avg` - 平均值
   - `min` / `max` - 最值

5. **事务支持**：
   - `begin_transaction`
   - `commit`
   - `rollback`

## 提示

<details>
<summary>Value 实现提示</summary>

```rust
impl From<i64> for Value {
    fn from(v: i64) -> Self {
        Value::Integer(v)
    }
}

impl Display for Value {
    fn fmt(&self, f: &mut Formatter<'_>) -> std::fmt::Result {
        match self {
            Value::Integer(i) => write!(f, "{}", i),
            Value::Float(fl) => write!(f, "{}", fl),
            Value::Text(s) => write!(f, "{}", s),
            Value::Boolean(b) => write!(f, "{}", b),
            Value::Null => write!(f, "NULL"),
        }
    }
}
```
</details>

<details>
<summary>Condition 匹配提示</summary>

```rust
impl Condition {
    pub fn matches(&self, row: &Row) -> bool {
        match self {
            Condition::Equals { column, value } => {
                row.data.get(column).map_or(false, |v| v == value)
            }
            Condition::GreaterThan { column, value } => {
                match (row.data.get(column), value) {
                    (Some(Value::Integer(a)), Value::Integer(b)) => a > b,
                    (Some(Value::Float(a)), Value::Float(b)) => a > b,
                    _ => false,
                }
            }
            // ... 其他条件
        }
    }
}
```
</details>

## 学习目标

通过本项目，你将：

1. **掌握结构体设计**：
   - 合理组织相关数据
   - 嵌套结构体的使用

2. **熟练使用枚举**：
   - 表示类型系统
   - 表示状态和条件

3. **实现复杂方法**：
   - 在 impl 块中实现方法
   - 处理错误情况

4. **使用 trait**：
   - From trait
   - Display trait

5. **处理复杂数据**：
   - HashMap 和 Vec 结合使用
   - 嵌套枚举和模式匹配

## 参考实现

完成项目后，可以查看 `solutions/database.rs` 中的参考实现。
