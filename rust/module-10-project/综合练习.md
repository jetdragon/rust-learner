# 10-综合项目 - 综合练习

## 项目：构建一个完整的待办事项应用

这个综合项目将运用你学到的所有 Rust 知识，构建一个功能完整的命令行待办事项管理应用。

### 第一阶段：核心功能 (必修)

#### 任务 1.1: 创建数据模型

定义以下数据结构：

```rust
// 优先级枚举
#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord)]
pub enum Priority {
    Low = 0,
    Medium = 1,
    High = 2,
}

impl std::fmt::Display for Priority {
    // 实现显示：低、中、高
}

impl std::str::FromStr for Priority {
    type Err = String;

    // 实现从字符串解析
    // 支持的输入："low", "medium", "high" (不区分大小写)
    // 也支持中文："低", "中", "高"
}

// 任务结构体
#[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]
pub struct Todo {
    pub id: u32,
    pub title: String,
    pub description: Option<String>,
    pub completed: bool,
    pub priority: Priority,
    pub tags: Vec<String>,
    pub created_at: chrono::DateTime<chrono::Utc>,
    pub completed_at: Option<chrono::DateTime<chrono::Utc>>,
}

impl Todo {
    pub fn new(id: u32, title: String, priority: Priority) -> Self {
        // 创建新任务
        // 自动设置 created_at 为当前时间
    }

    pub fn complete(&mut self) {
        // 标记任务为完成
        // 设置 completed 和 completed_at
    }

    pub fn uncomplete(&mut self) {
        // 取消完成状态
        // 清除 completed 和 completed_at
    }

    pub fn is_overdue(&self) -> bool {
        // 如果有截止日期，检查是否过期
        // 暂时返回 false
    }

    pub fn age(&self) -> chrono::Duration {
        // 返回任务创建至今的时间
    }
}
```

#### 任务 1.2: 实现任务列表管理器

```rust
#[derive(Debug, Clone)]
pub struct TodoList {
    todos: Vec<Todo>,
    next_id: u32,
}

impl TodoList {
    pub fn new() -> Self {
        // 创建空的任务列表
    }

    pub fn add(
        &mut self,
        title: String,
        description: Option<String>,
        priority: Priority,
        tags: Vec<String>,
    ) -> u32 {
        // 添加新任务，返回任务 ID
        // 自动递增 ID
    }

    pub fn get(&self, id: u32) -> Option<&Todo> {
        // 根据 ID 获取任务引用
    }

    pub fn get_mut(&mut self, id: u32) -> Option<&mut Todo> {
        // 根据 ID 获取可变引用
    }

    pub fn remove(&mut self, id: u32) -> Option<Todo> {
        // 删除任务，返回被删除的任务
    }

    pub fn complete(&mut self, id: u32) -> Result<(), String> {
        // 标记指定任务为完成
        // 如果任务不存在，返回错误
    }

    pub fn uncomplete(&mut self, id: u32) -> Result<(), String> {
        // 取消任务完成状态
    }

    pub fn len(&self) -> usize {
        // 返回任务数量
    }

    pub fn is_empty(&self) -> bool {
        // 检查是否为空
    }

    pub fn iter(&self) -> impl Iterator<Item = &Todo> {
        // 返回任务迭代器
    }

    pub fn active_count(&self) -> usize {
        // 返回未完成任务数量
    }

    pub fn completed_count(&self) -> usize {
        // 返回已完成任务数量
    }
}

impl Default for TodoList {
    fn default() -> Self {
        Self::new()
    }
}
```

#### 任务 1.3: 实现过滤器

```rust
pub enum Filter {
    All,
    Completed,
    Active,
    Priority(Priority),
    Tag(String),
    Search(String),
}

impl TodoList {
    pub fn filter(&self, filter: &Filter) -> Vec<&Todo> {
        match filter {
            Filter::All => self.todos.iter().collect(),
            Filter::Completed => {
                self.todos.iter().filter(|t| t.completed).collect()
            }
            Filter::Active => {
                self.todos.iter().filter(|t| !t.completed).collect()
            }
            Filter::Priority(p) => {
                self.todos.iter().filter(|t| t.priority == *p).collect()
            }
            Filter::Tag(tag) => {
                self.todos.iter().filter(|t| t.tags.contains(tag)).collect()
            }
            Filter::Search(query) => {
                self.todos
                    .iter()
                    .filter(|t| {
                        t.title.contains(query)
                            || t.description.as_ref().map_or(false, |d| d.contains(query))
                    })
                    .collect()
            }
        }
    }

    pub fn sort_by(&mut self, comparator: &dyn Fn(&Todo, &Todo) -> std::cmp::Ordering) {
        self.todos.sort_by(comparator);
    }

    pub fn sorted_by(&self, comparator: &dyn Fn(&Todo, &Todo) -> std::cmp::Ordering) -> Vec<&Todo> {
        let mut todos: Vec<&Todo> = self.todos.iter().collect();
        todos.sort_by(|a, b| comparator(a, b));
        todos
    }
}
```

### 第二阶段：持久化 (必修)

#### 任务 2.1: 定义错误类型

```rust
#[derive(Debug)]
pub enum Error {
    NotFound(u32),
    InvalidInput(String),
    Io(std::io::Error),
    Json(serde_json::Error),
}

impl std::fmt::Display for Error {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            Error::NotFound(id) => write!(f, "任务 {} 不存在", id),
            Error::InvalidInput(msg) => write!(f, "无效输入: {}", msg),
            Error::Io(e) => write!(f, "IO 错误: {}", e),
            Error::Json(e) => write!(f, "JSON 错误: {}", e),
        }
    }
}

impl std::error::Error for Error {}

impl From<std::io::Error> for Error {
    fn from(e: std::io::Error) -> Self {
        Error::Io(e)
    }
}

impl From<serde_json::Error> for Error {
    fn from(e: serde_json::Error) -> Self {
        Error::Json(e)
    }
}
```

#### 任务 2.2: 实现持久化

```rust
use std::path::Path;

pub trait Saveable {
    fn save<P: AsRef<Path>>(&self, path: P) -> Result<(), Error>;
    fn load<P: AsRef<Path>>(path: P) -> Result<Self, Error>
    where
        Self: Sized;
}

impl Saveable for TodoList {
    fn save<P: AsRef<Path>>(&self, path: P) -> Result<(), Error> {
        // 使用 serde_json 将任务列表序列化为 JSON
        // 写入指定文件
        // 创建备份文件
    }

    fn load<P: AsRef<Path>>(path: P) -> Result<Self, Error> {
        // 从文件读取 JSON
        // 反序列化为 TodoList
    }
}
```

### 第三阶段：命令行界面 (必修)

#### 任务 3.1: 定义命令

```rust
pub enum Command {
    Add {
        title: String,
        description: Option<String>,
        priority: Priority,
    },
    List {
        filter: Filter,
    },
    Complete { id: u32 },
    Delete { id: u32 },
    Edit {
        id: u32,
        title: Option<String>,
        description: Option<String>,
        priority: Option<Priority>,
    },
    Save { path: String },
    Load { path: String },
    Quit,
}

pub fn parse_command(input: &str) -> Result<Command, String> {
    // 解析用户输入
    // 支持以下格式：
    // "add <title>" - 添加任务
    // "add <title> -p <priority>" - 指定优先级
    // "list" - 列出所有任务
    // "list --completed" - 列出已完成
    // "list --active" - 列出未完成
    // "complete <id>" - 完成任务
    // "delete <id>" - 删除任务
    // "save <path>" - 保存
    // "load <path>" - 加载
    // "quit" - 退出
}
```

#### 任务 3.2: 实现交互式界面

```rust
pub fn run() -> Result<(), Error> {
    let mut todo_list = TodoList::new();

    println!("=== 待办事项管理器 ===");
    println!("输入 'help' 查看帮助，输入 'quit' 退出");

    loop {
        print!("\n> ");
        std::io::Write::flush(&mut std::io::stdout())?;

        let mut input = String::new();
        std::io::stdin().read_line(&mut input)?;

        let command = parse_command(input.trim())?;

        match command {
            Command::Quit => {
                println!("再见！");
                break;
            }
            Command::Add { title, description, priority } => {
                let id = todo_list.add(title, description, priority, vec![]);
                println!("任务 {} 已添加", id);
            }
            Command::List { filter } => {
                let todos = todo_list.filter(&filter);
                for todo in todos {
                    println!(
                        "{}: [{}] {} - {}",
                        todo.id,
                        if todo.completed { "✓" } else { " " },
                        todo.title,
                        todo.priority
                    );
                }
            }
            Command::Complete { id } => {
                todo_list.complete(id)?;
                println!("任务 {} 已完成", id);
            }
            Command::Delete { id } => {
                todo_list.remove(id);
                println!("任务 {} 已删除", id);
            }
            Command::Save { path } => {
                todo_list.save(&path)?;
                println!("已保存到 {}", path);
            }
            Command::Load { path } => {
                todo_list = TodoList::load(&path)?;
                println!("已从 {} 加载", path);
            }
            _ => {
                println!("未知命令");
            }
        }
    }

    Ok(())
}
```

### 第四阶段：测试 (必修)

为所有功能编写测试：

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_add_todo() {
        let mut list = TodoList::new();
        let id = list.add(
            String::from("测试任务"),
            None,
            Priority::Medium,
            vec![],
        );
        assert_eq!(id, 1);
        assert_eq!(list.len(), 1);
    }

    #[test]
    fn test_complete_todo() {
        let mut list = TodoList::new();
        let id = list.add(
            String::from("测试任务"),
            None,
            Priority::Medium,
            vec![],
        );
        list.complete(id).unwrap();
        let todo = list.get(id).unwrap();
        assert!(todo.completed);
    }

    #[test]
    fn test_delete_todo() {
        let mut list = TodoList::new();
        let id = list.add(
            String::from("测试任务"),
            None,
            Priority::Medium,
            vec![],
        );
        list.remove(id);
        assert_eq!(list.len(), 0);
        assert!(list.get(id).is_none());
    }

    #[test]
    fn test_filter_completed() {
        let mut list = TodoList::new();
        let id1 = list.add(
            String::from("任务1"),
            None,
            Priority::Medium,
            vec![],
        );
        let id2 = list.add(
            String::from("任务2"),
            None,
            Priority::Medium,
            vec![],
        );
        list.complete(id1).unwrap();

        let completed = list.filter(&Filter::Completed);
        assert_eq!(completed.len(), 1);
        assert_eq!(completed[0].id, id1);

        let active = list.filter(&Filter::Active);
        assert_eq!(active.len(), 1);
        assert_eq!(active[0].id, id2);
    }

    #[test]
    fn test_search() {
        let mut list = TodoList::new();
        list.add(
            String::from("学习 Rust 编程"),
            None,
            Priority::High,
            vec![String::from("学习")],
        );
        list.add(
            String::from("买菜"),
            None,
            Priority::Low,
            vec![],
        );

        let results = list.filter(&Filter::Search(String::from("Rust")));
        assert_eq!(results.len(), 1);
        assert!(results[0].title.contains("Rust"));
    }

    #[test]
    fn test_save_and_load() {
        let mut list = TodoList::new();
        list.add(
            String::from("测试任务"),
            Some(String::from("描述")),
            Priority::High,
            vec![String::from("测试")],
        );

        list.save("test.json").unwrap();
        let loaded = TodoList::load("test.json").unwrap();
        assert_eq!(loaded.len(), list.len());

        // 清理
        std::fs::remove_file("test.json").ok();
    }
}
```

### 第五阶段：高级功能 (选修)

1. **添加标签系统**
   - 支持添加/删除标签
   - 按标签筛选

2. **添加截止日期**
   - 为任务设置截止日期
   - 显示即将到期的任务
   - 过期任务高亮显示

3. **实现撤销/重做**
   - 记录操作历史
   - 支持撤销操作

4. **添加统计功能**
   - 显示完成率
   - 显示每日完成数量
   - 优先级分布

5. **实现导入导出**
   - 支持导出为 CSV
   - 支持从 CSV 导入
   - 支持备份恢复

### 验收标准

- [ ] 所有核心功能都能正常工作
- [ ] 所有测试通过
- [ ] 代码通过 clippy 检查，无警告
- [ ] 代码格式符合 rustfmt
- [ ] 有完整的 API 文档注释
- [ ] 有使用示例
- [ ] 有 README 说明如何使用

### 提交内容

1. 完整的源代码
2. 所有测试文件
3. README.md 说明文档
4. 运行示例截图或输出
